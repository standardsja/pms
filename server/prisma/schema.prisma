generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                           Int                         @id @default(autoincrement())
  externalId                   String?                     @unique
  email                        String                      @unique
  name                         String?
  passwordHash                 String?
  profileImage                 String?
  pinnedModule                 String?                     @default("procurement")
  ldapDN                       String?
  employeeId                   String?
  jobTitle                     String?
  phone                        String?
  address                      String?
  city                         String?
  country                      String?
  supervisor                   String?
  departmentId                 Int?
  createdAt                    DateTime                    @default(now())
  updatedAt                    DateTime                    @updatedAt
  failedLogins                 Int?                        @default(0)
  lastFailedLogin              DateTime?
  lastLogin                    DateTime?
  blocked                      Boolean?                    @default(false)
  blockedAt                    DateTime?
  blockedReason                String?
  blockedBy                    Int?
  auditLogs                    AuditLog[]
  managedDepartment            Department?                 @relation("departmentManager")
  assignedEvaluations          Evaluation[]                @relation("AssignedProcurementOfficer")
  createdEvaluations           Evaluation[]                @relation("EvaluationCreator")
  sectionAVerifications        Evaluation[]                @relation("SectionAVerifier")
  sectionBVerifications        Evaluation[]                @relation("SectionBVerifier")
  sectionCVerifications        Evaluation[]                @relation("SectionCVerifier")
  sectionDVerifications        Evaluation[]                @relation("SectionDVerifier")
  sectionEVerifications        Evaluation[]                @relation("SectionEVerifier")
  validatedEvaluations         Evaluation[]                @relation("EvaluationValidator")
  evaluationAssignments        EvaluationAssignment[]
  ideas                        Idea[]
  ideaComments                 IdeaComment[]
  stageHistory                 IdeaStageHistory[]
  loadBalancingSettingsUpdated LoadBalancingSettings[]     @relation("LoadBalancingUpdater")
  sentMessages                 Message[]                   @relation("MessagesSent")
  receivedMessages             Message[]                   @relation("MessagesReceived")
  notifications                Notification[]
  performanceMetrics           OfficerPerformanceMetrics[]
  refreshTokens                RefreshToken[]
  assignedRequests             Request[]                   @relation("requestAssignee")
  requests                     Request[]                   @relation("requestRequester")
  actions                      RequestAction[]             @relation("actionPerformedBy")
  assignmentLogs               RequestAssignmentLog[]
  attachmentsUploaded          RequestAttachment[]         @relation("attachmentUploadedBy")
  statusChanges                RequestStatusHistory[]      @relation("statusChangedBy")
  approvedRoleRequests         RoleRequest[]               @relation("RoleRequestApprovedBy")
  submittedRoleRequests        RoleRequest[]               @relation("RoleRequestSubmittedBy")
  department                   Department?                 @relation("userDepartment", fields: [departmentId], references: [id])
  roles                        UserRole[]
  votes                        Vote[]

  @@index([departmentId], map: "User_departmentId_fkey")
}

model Department {
  id           Int           @id @default(autoincrement())
  name         String
  code         String?       @unique
  managerId    Int?          @unique
  manager      User?         @relation("departmentManager", fields: [managerId], references: [id])
  requests     Request[]
  roleRequests RoleRequest[]
  users        User[]        @relation("userDepartment")
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  module      String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@index([module])
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id     Int  @id @default(autoincrement())
  userId Int
  roleId Int
  role   Role @relation(fields: [roleId], references: [id])
  user   User @relation(fields: [userId], references: [id])

  @@unique([userId, roleId])
  @@index([roleId], map: "UserRole_roleId_fkey")
}

model FundingSource {
  id       Int       @id @default(autoincrement())
  name     String
  code     String?
  notes    String?
  requests Request[]
}

model Vendor {
  id        Int       @id @default(autoincrement())
  name      String
  contact   Json?
  address   String?
  website   String?
  createdAt DateTime  @default(now())
  requests  Request[]
}

model Request {
  id                    Int                    @id @default(autoincrement())
  reference             String                 @unique
  title                 String
  description           String?
  requesterId           Int
  departmentId          Int?
  status                RequestStatus          @default(DRAFT)
  fundingSourceId       Int?
  budgetCode            String?
  totalEstimated        Decimal?               @db.Decimal(12, 2)
  currency              String?                @default("USD")
  priority              Priority?              @default(MEDIUM)
  procurementType       Json?
  expectedDelivery      DateTime?
  currentAssigneeId     Int?
  vendorId              Int?
  managerName           String?
  headName              String?
  managerApproved       Boolean?               @default(false)
  headApproved          Boolean?               @default(false)
  commitmentNumber      String?
  accountingCode        String?
  budgetComments        String?
  budgetOfficerName     String?
  budgetManagerName     String?
  procurementCaseNumber String?
  receivedBy            String?
  dateReceived          String?
  procurementApproved   Boolean?               @default(false)
  actionDate            String?
  procurementComments   String?
  headerDeptCode        String?
  headerMonth           String?
  headerYear            Int?
  headerSequence        Int?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  submittedAt           DateTime?
  isCombined            Boolean?               @default(false)
  combinedRequestId     Int?
  lotNumber             Int?
  evaluations           Evaluation[]           @relation("RequestEvaluations")
  combinedRequest       CombinedRequest?       @relation("CombinedRequestLots", fields: [combinedRequestId], references: [id])
  currentAssignee       User?                  @relation("requestAssignee", fields: [currentAssigneeId], references: [id])
  department            Department?            @relation(fields: [departmentId], references: [id])
  fundingSource         FundingSource?         @relation(fields: [fundingSourceId], references: [id])
  requester             User                   @relation("requestRequester", fields: [requesterId], references: [id])
  vendor                Vendor?                @relation(fields: [vendorId], references: [id])
  actions               RequestAction[]
  assignmentLogs        RequestAssignmentLog[]
  attachments           RequestAttachment[]
  items                 RequestItem[]
  statusHistory         RequestStatusHistory[]
  splinteringAlerts     SplinteringAlert[]

  @@index([combinedRequestId], map: "Request_combinedRequestId_fkey")
  @@index([currentAssigneeId], map: "Request_currentAssigneeId_fkey")
  @@index([departmentId], map: "Request_departmentId_fkey")
  @@index([fundingSourceId], map: "Request_fundingSourceId_fkey")
  @@index([requesterId], map: "Request_requesterId_fkey")
  @@index([vendorId], map: "Request_vendorId_fkey")
}

model CombinedRequest {
  id          Int          @id @default(autoincrement())
  reference   String       @unique
  title       String
  description String?      @db.Text
  config      Json?
  createdBy   Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  evaluations Evaluation[] @relation("CombinedRequestEvaluations")
  lots        Request[]    @relation("CombinedRequestLots")

  @@index([reference])
}

model RequestItem {
  id            Int     @id @default(autoincrement())
  requestId     Int
  description   String
  quantity      Int     @default(1)
  unitPrice     Decimal @db.Decimal(12, 2)
  totalPrice    Decimal @db.Decimal(12, 2)
  accountCode   String?
  stockLevel    String?
  unitOfMeasure String?
  partNumber    String?
  request       Request @relation(fields: [requestId], references: [id])

  @@index([requestId], map: "RequestItem_requestId_fkey")
}

model RequestAttachment {
  id           Int      @id @default(autoincrement())
  requestId    Int
  filename     String
  url          String
  mimeType     String?
  uploadedById Int?
  uploadedAt   DateTime @default(now())
  request      Request  @relation(fields: [requestId], references: [id])
  uploadedBy   User?    @relation("attachmentUploadedBy", fields: [uploadedById], references: [id])

  @@index([requestId], map: "RequestAttachment_requestId_fkey")
  @@index([uploadedById], map: "RequestAttachment_uploadedById_fkey")
}

model RequestAction {
  id            Int               @id @default(autoincrement())
  requestId     Int
  action        RequestActionType
  comment       String?
  performedById Int?
  metadata      Json?
  createdAt     DateTime          @default(now())
  performedBy   User?             @relation("actionPerformedBy", fields: [performedById], references: [id])
  request       Request           @relation(fields: [requestId], references: [id])

  @@index([performedById], map: "RequestAction_performedById_fkey")
  @@index([requestId], map: "RequestAction_requestId_fkey")
}

model RequestStatusHistory {
  id          Int           @id @default(autoincrement())
  requestId   Int
  status      RequestStatus
  changedById Int?
  comment     String?
  createdAt   DateTime      @default(now())
  changedBy   User?         @relation("statusChangedBy", fields: [changedById], references: [id])
  request     Request       @relation(fields: [requestId], references: [id])

  @@index([changedById], map: "RequestStatusHistory_changedById_fkey")
  @@index([requestId], map: "RequestStatusHistory_requestId_fkey")
}

model Idea {
  id              Int                @id @default(autoincrement())
  title           String
  description     String             @db.Text
  descriptionHtml String?            @db.Text
  category        IdeaCategory
  status          IdeaStatus         @default(DRAFT)
  stage           Stage              @default(DISCOVERY)
  isAnonymous     Boolean            @default(false)
  challengeId     Int?
  submittedBy     Int
  submittedAt     DateTime           @default(now())
  reviewedBy      Int?
  reviewedAt      DateTime?
  reviewNotes     String?            @db.Text
  promotedAt      DateTime?
  projectCode     String?            @unique
  voteCount       Int                @default(0)
  upvoteCount     Int                @default(0)
  downvoteCount   Int                @default(0)
  viewCount       Int                @default(0)
  trendingScore   Float              @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  auditLogs       AuditLog[]
  challenge       Challenge?         @relation(fields: [challengeId], references: [id])
  submitter       User               @relation(fields: [submittedBy], references: [id])
  attachments     IdeaAttachment[]
  comments        IdeaComment[]
  stageHistory    IdeaStageHistory[]
  tags            IdeaTag[]
  votes           Vote[]

  @@index([status])
  @@index([category])
  @@index([submittedBy])
  @@index([createdAt])
  @@index([voteCount])
  @@index([trendingScore])
  @@index([status, createdAt])
  @@index([status, voteCount])
  @@index([status, trendingScore])
  @@index([category, status])
  @@index([submittedBy, status])
  @@index([promotedAt])
  @@index([reviewedBy, reviewedAt])
  @@index([challengeId], map: "Idea_challengeId_fkey")
}

model Vote {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  userId    Int
  voteType  VoteType @default(UPVOTE)
  createdAt DateTime @default(now())
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ideaId, userId])
  @@index([ideaId])
  @@index([userId])
}

model IdeaComment {
  id        Int           @id @default(autoincrement())
  ideaId    Int
  userId    Int
  text      String        @db.Text
  parentId  Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  idea      Idea          @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  parent    IdeaComment?  @relation("IdeaCommentParent", fields: [parentId], references: [id])
  replies   IdeaComment[] @relation("IdeaCommentParent")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ideaId])
  @@index([userId])
  @@index([parentId])
}

model IdeaAttachment {
  id         Int                  @id @default(autoincrement())
  ideaId     Int
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String?
  safeStatus AttachmentSafeStatus @default(PENDING)
  uploadedAt DateTime             @default(now())
  idea       Idea                 @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  @@index([ideaId])
}

model Tag {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  createdAt DateTime  @default(now())
  ideas     IdeaTag[]
}

model IdeaTag {
  ideaId Int
  tagId  Int
  idea   Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([ideaId, tagId])
  @@index([tagId])
}

model IdeaCount {
  id        Int        @id @default(autoincrement())
  status    IdeaStatus @unique
  count     Int        @default(0)
  updatedAt DateTime   @default(now()) @updatedAt
}

model Challenge {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  startAt     DateTime?
  endAt       DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  ideas       Idea[]
}

model IdeaStageHistory {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  fromStage Stage?
  toStage   Stage
  note      String?
  userId    Int?
  createdAt DateTime @default(now())
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([ideaId])
  @@index([userId], map: "IdeaStageHistory_userId_fkey")
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    Int?
  action    AuditAction
  entity    String
  entityId  Int?
  message   String      @db.Text
  ipAddress String?
  userAgent String?     @db.Text
  metadata  Json?
  ideaId    Int?
  createdAt DateTime    @default(now())
  idea      Idea?       @relation(fields: [ideaId], references: [id])
  user      User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity, entityId])
  @@index([createdAt])
  @@index([ideaId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  message   String
  data      Json?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Message {
  id         Int       @id @default(autoincrement())
  fromUserId Int
  toUserId   Int
  subject    String
  body       String    @db.Text
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  fromUser   User      @relation("MessagesSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User      @relation("MessagesReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([toUserId])
  @@index([fromUserId])
  @@index([createdAt])
}

model Evaluation {
  id                           Int                       @id @default(autoincrement())
  evalNumber                   String                    @unique
  rfqNumber                    String
  rfqTitle                     String
  description                  String?                   @db.Text
  status                       EvaluationStatus          @default(PENDING)
  assignedProcurementOfficerId Int?
  combinedRequestId            Int?
  requestId                    Int?
  sectionA                     Json?
  sectionAStatus               SectionVerificationStatus @default(NOT_STARTED)
  sectionAVerifiedBy           Int?
  sectionAVerifiedAt           DateTime?
  sectionANotes                String?                   @db.Text
  sectionB                     Json?
  sectionBStatus               SectionVerificationStatus @default(NOT_STARTED)
  sectionBVerifiedBy           Int?
  sectionBVerifiedAt           DateTime?
  sectionBNotes                String?                   @db.Text
  sectionC                     Json?
  sectionCStatus               SectionVerificationStatus @default(NOT_STARTED)
  sectionCVerifiedBy           Int?
  sectionCVerifiedAt           DateTime?
  sectionCNotes                String?                   @db.Text
  sectionD                     Json?
  sectionDStatus               SectionVerificationStatus @default(NOT_STARTED)
  sectionDVerifiedBy           Int?
  sectionDVerifiedAt           DateTime?
  sectionDNotes                String?                   @db.Text
  sectionE                     Json?
  sectionEStatus               SectionVerificationStatus @default(NOT_STARTED)
  sectionEVerifiedBy           Int?
  sectionEVerifiedAt           DateTime?
  sectionENotes                String?                   @db.Text
  createdBy                    Int
  evaluator                    String?
  dueDate                      DateTime?
  dateSubmissionConsidered     DateTime?
  reportCompletionDate         DateTime?
  validatedBy                  Int?
  validatedAt                  DateTime?
  validationNotes              String?                   @db.Text
  createdAt                    DateTime                  @default(now())
  updatedAt                    DateTime                  @updatedAt
  assignedProcurementOfficer   User?                     @relation("AssignedProcurementOfficer", fields: [assignedProcurementOfficerId], references: [id])
  combinedRequest              CombinedRequest?          @relation("CombinedRequestEvaluations", fields: [combinedRequestId], references: [id])
  creator                      User                      @relation("EvaluationCreator", fields: [createdBy], references: [id])
  request                      Request?                  @relation("RequestEvaluations", fields: [requestId], references: [id])
  sectionAVerifier             User?                     @relation("SectionAVerifier", fields: [sectionAVerifiedBy], references: [id])
  sectionBVerifier             User?                     @relation("SectionBVerifier", fields: [sectionBVerifiedBy], references: [id])
  sectionCVerifier             User?                     @relation("SectionCVerifier", fields: [sectionCVerifiedBy], references: [id])
  sectionDVerifier             User?                     @relation("SectionDVerifier", fields: [sectionDVerifiedBy], references: [id])
  sectionEVerifier             User?                     @relation("SectionEVerifier", fields: [sectionEVerifiedBy], references: [id])
  validator                    User?                     @relation("EvaluationValidator", fields: [validatedBy], references: [id])
  assignments                  EvaluationAssignment[]

  @@index([status])
  @@index([createdBy])
  @@index([evalNumber])
  @@index([requestId])
  @@index([rfqNumber])
  @@index([assignedProcurementOfficerId], map: "Evaluation_assignedProcurementOfficerId_fkey")
  @@index([combinedRequestId], map: "Evaluation_combinedRequestId_fkey")
  @@index([sectionAVerifiedBy], map: "Evaluation_sectionAVerifiedBy_fkey")
  @@index([sectionBVerifiedBy], map: "Evaluation_sectionBVerifiedBy_fkey")
  @@index([sectionCVerifiedBy], map: "Evaluation_sectionCVerifiedBy_fkey")
  @@index([sectionDVerifiedBy], map: "Evaluation_sectionDVerifiedBy_fkey")
  @@index([sectionEVerifiedBy], map: "Evaluation_sectionEVerifiedBy_fkey")
  @@index([validatedBy], map: "Evaluation_validatedBy_fkey")
}

/// Per-user assignment to contribute to an Evaluation
model EvaluationAssignment {
  id           Int              @id @default(autoincrement())
  evaluationId Int
  userId       Int
  sections     Json
  status       AssignmentStatus @default(PENDING)
  submittedAt  DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  evaluation   Evaluation       @relation(fields: [evaluationId], references: [id])
  user         User             @relation(fields: [userId], references: [id])

  @@unique([evaluationId, userId])
  @@index([userId])
}

model LoadBalancingSettings {
  id                   Int                   @id @default(autoincrement())
  enabled              Boolean               @default(false)
  strategy             LoadBalancingStrategy @default(LEAST_LOADED)
  autoAssignOnApproval Boolean               @default(true)
  splinteringEnabled   Boolean               @default(false)
  roundRobinCounter    Int                   @default(0)
  updatedAt            DateTime              @updatedAt
  updatedBy            Int?
  aiEnabled            Boolean               @default(true)
  lastRoundRobinIndex  Int                   @default(0)
  learningEnabled      Boolean               @default(true)
  minConfidenceScore   Float                 @default(0.6)
  performanceWeighting Float                 @default(1.5)
  priorityWeighting    Float                 @default(1)
  specialtyWeighting   Float                 @default(1.3)
  workloadWeighting    Float                 @default(1.2)
  user                 User?                 @relation("LoadBalancingUpdater", fields: [updatedBy], references: [id])

  @@index([updatedBy], map: "LoadBalancingSettings_updatedBy_fkey")
}

/// Performance metrics for procurement officers (used by advanced load balancing / analytics)
model OfficerPerformanceMetrics {
  id                       Int       @id @default(autoincrement())
  officerId                Int
  activeAssignments        Int       @default(0)
  completedAssignments     Int       @default(0)
  averageTurnaroundMinutes Int?
  lastAssignmentAt         DateTime?
  loadScore                Float?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  averageCompletionTime    Int       @default(24)
  categoryExpertise        Json
  complexityHandling       Float     @default(0.5)
  currentWorkload          Int       @default(0)
  efficiencyScore          Float     @default(0.8)
  lastAssignedAt           DateTime?
  peakPerformanceHours     Json
  successRate              Float     @default(0.8)
  officer                  User      @relation(fields: [officerId], references: [id], onDelete: Cascade)

  @@index([officerId])
}

/// Log of request assignment events for auditing and future ML feature engineering
model RequestAssignmentLog {
  id                      Int                    @id @default(autoincrement())
  requestId               Int
  officerId               Int
  strategy                LoadBalancingStrategy?
  previousOfficerId       Int?
  notes                   String?
  assignedAt              DateTime               @default(now())
  createdAt               DateTime               @default(now())
  actualCompletionTime    Float?
  confidenceScore         Float?
  predictedCompletionTime Float?
  officer                 User                   @relation(fields: [officerId], references: [id])
  request                 Request                @relation(fields: [requestId], references: [id])

  @@index([requestId])
  @@index([officerId])
}

/// Role request model for tracking user role assignment requests
/// Users request access to modules like Procurement, admins approve/reject
model RoleRequest {
  id           Int               @id @default(autoincrement())
  userId       Int
  departmentId Int?
  role         String
  module       String
  status       RoleRequestStatus @default(PENDING)
  reason       String?           @db.Text
  notes        String?           @db.Text
  approvedById Int?
  approvedAt   DateTime?
  rejectedAt   DateTime?
  expiresAt    DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  approvedBy   User?             @relation("RoleRequestApprovedBy", fields: [approvedById], references: [id])
  department   Department?       @relation(fields: [departmentId], references: [id])
  user         User              @relation("RoleRequestSubmittedBy", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([approvedById], map: "RoleRequest_approvedById_fkey")
  @@index([departmentId], map: "RoleRequest_departmentId_fkey")
}

/// Splintering Detection Alert - tracks potential procurement splitting attempts
model SplinteringAlert {
  id         Int       @id @default(autoincrement())
  requestId  Int?
  alertType  String
  severity   String
  message    String    @db.Text
  details    Json?
  userId     Int?
  wasBlocked Boolean   @default(false)
  reviewedBy Int?
  reviewedAt DateTime?
  resolution String?   @db.Text
  createdAt  DateTime  @default(now())
  request    Request?  @relation(fields: [requestId], references: [id])

  @@index([requestId])
  @@index([alertType])
  @@index([severity])
  @@index([createdAt])
  @@index([wasBlocked])
}

/// *
/// * System Configuration
/// * Stores system-wide settings and configuration
model SystemConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.Text
  valueType   String   @default("string")
  description String?  @db.Text
  updatedBy   Int?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([key])
  @@index([updatedAt])
}

/// *
/// * Anti-Splintering Rules
/// * Defines rules for detecting procurement splintering attempts
model SplinteringRule {
  id              Int      @id @default(autoincrement())
  ruleId          String   @unique
  name            String
  description     String?  @db.Text
  thresholdAmount Decimal  @db.Decimal(12, 2)
  timeWindowDays  Int      @default(90)
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([enabled])
  @@index([ruleId])
}

/// *
/// * Workflow Status
/// * Defines possible workflow states in the procurement process
model WorkflowStatus {
  id           Int      @id @default(autoincrement())
  statusId     String   @unique
  name         String
  description  String?  @db.Text
  color        String   @default("#3B82F6")
  icon         String?
  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
}

/// *
/// * Workflow SLA
/// * Service Level Agreements for workflow transitions
model WorkflowSLA {
  id          Int      @id @default(autoincrement())
  slaId       String   @unique
  name        String
  description String?  @db.Text
  fromStatus  String
  toStatus    String
  slaHours    Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([fromStatus, toStatus])
  @@index([isActive])
}

/// *
/// * Navigation Menu
/// * Stores menu items displayed in application headers/sidebars
model NavigationMenu {
  id           Int      @id @default(autoincrement())
  menuId       String   @unique
  label        String
  icon         String?
  path         String
  description  String?  @db.Text
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
}

/// Refresh token model for JWT token rotation
model RefreshToken {
  id             Int            @id @default(autoincrement())
  tokenHash      String         @unique
  userId         Int
  expiresAt      DateTime
  revoked        Boolean        @default(false)
  replacedById   Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  replacedBy     RefreshToken?  @relation("replacedByRelation", fields: [replacedById], references: [id])
  replacedTokens RefreshToken[] @relation("replacedByRelation")
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([revoked])
  @@index([replacedById], map: "RefreshToken_replacedById_fkey")
}

/// *
/// * ===== Enums =====
enum RequestStatus {
  DRAFT
  SUBMITTED
  DEPARTMENT_REVIEW
  DEPARTMENT_RETURNED
  DEPARTMENT_APPROVED
  EXECUTIVE_REVIEW
  HOD_REVIEW
  PROCUREMENT_REVIEW
  FINANCE_REVIEW
  FINANCE_RETURNED
  BUDGET_MANAGER_REVIEW
  FINANCE_APPROVED
  SENT_TO_VENDOR
  CLOSED
  REJECTED
}

enum RequestActionType {
  SUBMIT
  APPROVE
  RETURN
  ASSIGN
  EDIT_BUDGET
  COMMENT
  SEND_TO_VENDOR
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum IdeaStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PROMOTED_TO_PROJECT
}

enum IdeaCategory {
  PROCESS_IMPROVEMENT
  TECHNOLOGY
  CUSTOMER_SERVICE
  SUSTAINABILITY
  COST_REDUCTION
  PRODUCT_INNOVATION
  OTHER
}

enum Stage {
  DISCOVERY
  EVALUATION
  INCUBATION
  IMPLEMENTATION
  COMPLETED
}

enum AttachmentSafeStatus {
  PENDING
  CLEAN
  INFECTED
}

enum NotificationType {
  MENTION
  STAGE_CHANGED
  IDEA_APPROVED
  THRESHOLD_EXCEEDED
  EVALUATION_VERIFIED
  EVALUATION_RETURNED
}

enum AuditAction {
  USER_LOGIN
  USER_LOGOUT
  USER_LOGIN_FAILED
  LDAP_LOGIN
  PASSWORD_CHANGED
  ROLE_ASSIGNED
  ROLE_REMOVED
  REQUEST_CREATED
  REQUEST_UPDATED
  REQUEST_DELETED
  REQUEST_SUBMITTED
  REQUEST_APPROVED
  REQUEST_REJECTED
  REQUEST_FORWARDED
  REQUEST_RETURNED
  REQUEST_STATUS_CHANGED
  PO_CREATED
  PO_UPDATED
  PO_APPROVED
  PO_CANCELLED
  APPROVAL_GRANTED
  APPROVAL_DENIED
  APPROVAL_DELEGATED
  WORKFLOW_STAGE_CHANGED
  BUDGET_ALLOCATED
  BUDGET_MODIFIED
  PAYMENT_PROCESSED
  FILE_UPLOADED
  FILE_DOWNLOADED
  FILE_DELETED
  IDEA_CREATED
  IDEA_UPDATED
  IDEA_VOTED
  IDEA_DELETED
  COMMENT_CREATED
  COMMENT_DELETED
  STAGE_CHANGED
  TAGS_UPDATED
  SUPPLIER_CREATED
  SUPPLIER_UPDATED
  SUPPLIER_APPROVED
  SUPPLIER_SUSPENDED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  SETTINGS_CHANGED
  REPORT_GENERATED
  DATA_EXPORTED
}

enum LoadBalancingStrategy {
  LEAST_LOADED
  ROUND_ROBIN
  RANDOM
  AI_SMART
  SKILL_BASED
  PREDICTIVE
}

enum RoleRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum EvaluationStatus {
  PENDING
  IN_PROGRESS
  COMMITTEE_REVIEW
  COMPLETED
  VALIDATED
  REJECTED
}

enum SectionVerificationStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  RETURNED
  VERIFIED
}

enum AssignmentStatus {
  PENDING
  SUBMITTED
}
