generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/**
 * ===== Enums =====
 */
enum RequestStatus {
  DRAFT
  SUBMITTED
  DEPARTMENT_REVIEW
  DEPARTMENT_RETURNED
  DEPARTMENT_APPROVED
  HOD_REVIEW
  PROCUREMENT_REVIEW
  FINANCE_REVIEW
  FINANCE_RETURNED
  FINANCE_APPROVED
  SENT_TO_VENDOR
  CLOSED
  REJECTED
}

enum RequestActionType {
  SUBMIT
  APPROVE
  RETURN
  ASSIGN
  EDIT_BUDGET
  COMMENT
  SEND_TO_VENDOR
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum IdeaStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PROMOTED_TO_PROJECT
}

enum IdeaCategory {
  PROCESS_IMPROVEMENT
  TECHNOLOGY
  CUSTOMER_SERVICE
  SUSTAINABILITY
  COST_REDUCTION
  PRODUCT_INNOVATION
  OTHER
}

/**
 * ===== Models =====
 */

model User {
  id           Int     @id @default(autoincrement())
  externalId   String? @unique
  email        String  @unique
  name         String?
  passwordHash String? // ‚Üê for local email/password testing

  department   Department? @relation("userDepartment", fields: [departmentId], references: [id])
  departmentId Int?

  managedDepartment   Department?            @relation("departmentManager")
  roles               UserRole[]
  requests            Request[]              @relation("requestRequester")
  assignedRequests    Request[]              @relation("requestAssignee")
  actions             RequestAction[]        @relation("actionPerformedBy")
  attachmentsUploaded RequestAttachment[]    @relation("attachmentUploadedBy")
  statusChanges       RequestStatusHistory[] @relation("statusChangedBy")
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  // Innovation Hub relations
  ideas        Idea[]
  votes        Vote[]
  ideaComments IdeaComment[]
}

model Department {
  id   Int     @id @default(autoincrement())
  name String
  code String? @unique

  // one manager per department
  manager   User? @relation("departmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  managerId Int?  @unique // <-- make the FK unique

  users    User[]    @relation("userDepartment")
  requests Request[]
}

model Role {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  users       UserRole[]
}

model UserRole {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int
  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  @@unique([userId, roleId])
}

model FundingSource {
  id       Int       @id @default(autoincrement())
  name     String
  code     String?
  notes    String?
  requests Request[] // back-relation for Request.fundingSource
}

model Vendor {
  id        Int       @id @default(autoincrement())
  name      String
  contact   Json?
  address   String?
  website   String?
  createdAt DateTime  @default(now())
  requests  Request[] // back-relation for Request.vendor
}

model Request {
  id          Int     @id @default(autoincrement())
  reference   String  @unique
  title       String
  description String?

  requester   User @relation("requestRequester", fields: [requesterId], references: [id])
  requesterId Int

  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId Int?

  items         RequestItem[]
  attachments   RequestAttachment[]
  actions       RequestAction[]
  statusHistory RequestStatusHistory[]

  status RequestStatus @default(DRAFT)

  fundingSource   FundingSource? @relation(fields: [fundingSourceId], references: [id])
  fundingSourceId Int?

  budgetCode       String?
  totalEstimated   Decimal?  @db.Decimal(12, 2)
  currency         String?   @default("USD")
  priority         Priority? @default(MEDIUM)
  procurementType  Json?     // Array of procurement types: ['goods', 'consulting', etc.]
  expectedDelivery DateTime?

  currentAssignee   User? @relation("requestAssignee", fields: [currentAssigneeId], references: [id])
  currentAssigneeId Int?

  vendor   Vendor? @relation(fields: [vendorId], references: [id])
  vendorId Int?

  // Manager/HOD section fields
  managerName String?
  headName    String?
  managerApproved Boolean? @default(false)
  headApproved    Boolean? @default(false)

  // Budget section fields
  commitmentNumber  String?
  accountingCode    String?
  budgetComments    String?
  budgetOfficerName String?
  budgetManagerName String?

  // Procurement section fields
  procurementCaseNumber String?
  receivedBy            String?
  dateReceived          String?
  procurementApproved   Boolean? @default(false)
  actionDate            String?
  procurementComments   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?
}

model RequestItem {
  id            Int     @id @default(autoincrement())
  request       Request @relation(fields: [requestId], references: [id])
  requestId     Int
  description   String
  quantity      Int     @default(1)
  unitPrice     Decimal @db.Decimal(12, 2)
  totalPrice    Decimal @db.Decimal(12, 2)
  accountCode   String?
  stockLevel    String?
  unitOfMeasure String?
  partNumber    String?
}

model RequestAttachment {
  id        Int     @id @default(autoincrement())
  request   Request @relation(fields: [requestId], references: [id])
  requestId Int
  filename  String
  url       String
  mimeType  String?

  uploadedBy   User? @relation("attachmentUploadedBy", fields: [uploadedById], references: [id])
  uploadedById Int?

  uploadedAt DateTime @default(now())
}

model RequestAction {
  id        Int     @id @default(autoincrement())
  request   Request @relation(fields: [requestId], references: [id])
  requestId Int

  action  RequestActionType
  comment String?

  performedBy   User? @relation("actionPerformedBy", fields: [performedById], references: [id])
  performedById Int?

  metadata  Json?
  createdAt DateTime @default(now())
}

model RequestStatusHistory {
  id        Int           @id @default(autoincrement())
  request   Request       @relation(fields: [requestId], references: [id])
  requestId Int
  status    RequestStatus

  changedBy   User? @relation("statusChangedBy", fields: [changedById], references: [id])
  changedById Int?

  comment   String?
  createdAt DateTime @default(now())
}

// ============================================
// INNOVATION HUB DOMAIN
// ============================================

enum VoteType {
  UPVOTE
  DOWNVOTE
}

model Idea {
  id             Int          @id @default(autoincrement())
  title          String
  description    String       @db.Text
  category       IdeaCategory
  status         IdeaStatus   @default(DRAFT)
  
  // Submission
  submittedBy    Int
  submitter      User         @relation(fields: [submittedBy], references: [id])
  submittedAt    DateTime     @default(now())
  
  // Review
  reviewedBy     Int?
  reviewedAt     DateTime?
  reviewNotes    String?      @db.Text
  
  // Promotion
  promotedAt     DateTime?
  projectCode    String?      @unique
  
  // Metadata
  voteCount      Int          @default(0)
  upvoteCount    Int          @default(0)
  downvoteCount  Int          @default(0)
  viewCount      Int          @default(0)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  votes          Vote[]
  comments       IdeaComment[]
  attachments    IdeaAttachment[]

  @@index([status])
  @@index([category])
  @@index([submittedBy])
  @@index([createdAt])
  @@index([voteCount])
}

model Vote {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voteType  VoteType @default(UPVOTE)
  createdAt DateTime @default(now())

  @@unique([ideaId, userId])
  @@index([ideaId])
  @@index([userId])
}

model IdeaComment {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String   @db.Text
  createdAt DateTime @default(now())

  @@index([ideaId])
  @@index([userId])
}

model IdeaAttachment {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String?
  uploadedAt DateTime @default(now())

  @@index([ideaId])
}
