generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ========= Enums ========= */

enum RequestStatus {
  DRAFT
  SUBMITTED
  DEPARTMENT_REVIEW
  DEPARTMENT_RETURNED
  DEPARTMENT_APPROVED
  HOD_REVIEW
  PROCUREMENT_REVIEW
  FINANCE_REVIEW
  BUDGET_MANAGER_REVIEW
  FINANCE_RETURNED
  FINANCE_APPROVED
  SENT_TO_VENDOR
  CLOSED
  REJECTED
}

enum RequestActionType {
  SUBMIT
  APPROVE
  RETURN
  ASSIGN
  EDIT_BUDGET
  COMMENT
  SEND_TO_VENDOR
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum IdeaStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PROMOTED_TO_PROJECT
}

enum IdeaCategory {
  PROCESS_IMPROVEMENT
  TECHNOLOGY
  CUSTOMER_SERVICE
  SUSTAINABILITY
  COST_REDUCTION
  PRODUCT_INNOVATION
  OTHER
}

enum Stage {
  DISCOVERY
  EVALUATION
  INCUBATION
  IMPLEMENTATION
  COMPLETED
}

enum AttachmentSafeStatus {
  PENDING
  CLEAN
  INFECTED
}

enum NotificationType {
  MENTION
  STAGE_CHANGED
  IDEA_APPROVED
}

enum AuditAction {
  IDEA_CREATED
  IDEA_UPDATED
  IDEA_VOTED
  COMMENT_CREATED
  STAGE_CHANGED
  TAGS_UPDATED
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

/* ========= Models ========= */

model User {
  id           Int     @id @default(autoincrement())
  externalId   String? @unique
  email        String  @unique
  name         String?
  passwordHash String?

  department   Department? @relation("userDepartment", fields: [departmentId], references: [id])
  departmentId Int?

  managedDepartment   Department?            @relation("departmentManager")
  roles               UserRole[]
  requests            Request[]              @relation("requestRequester")
  assignedRequests    Request[]              @relation("requestAssignee")
  actions             RequestAction[]        @relation("actionPerformedBy")
  attachmentsUploaded RequestAttachment[]    @relation("attachmentUploadedBy")
  statusChanges       RequestStatusHistory[] @relation("statusChangedBy")
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  // Innovation Hub
  ideas         Idea[]
  votes         Vote[]
  ideaComments  IdeaComment[]
  stageHistory  IdeaStageHistory[]
  auditLogs     AuditLog[]
  notifications Notification[]
}

model Department {
  id   Int     @id @default(autoincrement())
  name String
  code String? @unique

  manager   User? @relation("departmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  managerId Int?  @unique

  users    User[]    @relation("userDepartment")
  requests Request[]
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String?
  users       UserRole[]
}

model UserRole {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int
  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  @@unique([userId, roleId])
}

model FundingSource {
  id       Int       @id @default(autoincrement())
  name     String
  code     String?
  notes    String?
  requests Request[]
}

model Vendor {
  id        Int       @id @default(autoincrement())
  name      String
  contact   Json?
  address   String?
  website   String?
  createdAt DateTime  @default(now())
  requests  Request[]
}

model Request {
  id          Int     @id @default(autoincrement())
  reference   String  @unique
  title       String
  description String?

  requester   User @relation("requestRequester", fields: [requesterId], references: [id])
  requesterId Int

  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId Int?

  items         RequestItem[]
  attachments   RequestAttachment[]
  actions       RequestAction[]
  statusHistory RequestStatusHistory[]

  status RequestStatus @default(DRAFT)

  fundingSource   FundingSource? @relation(fields: [fundingSourceId], references: [id])
  fundingSourceId Int?

  budgetCode       String?
  totalEstimated   Decimal?  @db.Decimal(12, 2)
  currency         String?   @default("JMD")
  priority         Priority? @default(MEDIUM)
  procurementType  Json?
  expectedDelivery DateTime?

  currentAssignee   User? @relation("requestAssignee", fields: [currentAssigneeId], references: [id])
  currentAssigneeId Int?

  vendor   Vendor? @relation(fields: [vendorId], references: [id])
  vendorId Int?

  // Manager/HOD
  managerName      String?
  headName         String?
  managerApproved  Boolean? @default(false)
  headApproved     Boolean? @default(false)

  // Budget
  commitmentNumber       String?
  accountingCode         String?
  budgetComments         String?
  budgetOfficerName      String?
  budgetManagerName      String?
  budgetOfficerApproved  Boolean? @default(false)
  budgetManagerApproved  Boolean? @default(false)

  // Procurement
  procurementCaseNumber String?
  receivedBy            String?
  dateReceived          String?
  procurementApproved   Boolean? @default(false)
  actionDate            String?
  procurementComments   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?
}

model RequestItem {
  id            Int     @id @default(autoincrement())
  request       Request @relation(fields: [requestId], references: [id])
  requestId     Int
  description   String
  quantity      Int     @default(1)
  unitPrice     Decimal @db.Decimal(12, 2)
  totalPrice    Decimal @db.Decimal(12, 2)
  accountCode   String?
  stockLevel    String?
  unitOfMeasure String?
  partNumber    String?
}

model RequestAttachment {
  id        Int     @id @default(autoincrement())
  request   Request @relation(fields: [requestId], references: [id])
  requestId Int
  filename  String
  url       String
  mimeType  String?

  uploadedBy   User? @relation("attachmentUploadedBy", fields: [uploadedById], references: [id])
  uploadedById Int?

  safeStatus AttachmentSafeStatus @default(PENDING)
  uploadedAt DateTime @default(now())
}

model RequestAction {
  id        Int     @id @default(autoincrement())
  request   Request @relation(fields: [requestId], references: [id])
  requestId Int

  action  RequestActionType
  comment String?

  performedBy   User? @relation("actionPerformedBy", fields: [performedById], references: [id])
  performedById Int?

  metadata  Json?
  createdAt DateTime @default(now())
}

model RequestStatusHistory {
  id        Int           @id @default(autoincrement())
  request   Request       @relation(fields: [requestId], references: [id])
  requestId Int
  status    RequestStatus

  changedBy   User? @relation("statusChangedBy", fields: [changedById], references: [id])
  changedById Int?

  comment   String?
  createdAt DateTime @default(now())
}

/* ===== Innovation Hub ===== */

model Idea {
  id              Int          @id @default(autoincrement())
  title           String
  description     String       @db.Text
  descriptionHtml String?      @db.Text
  category        IdeaCategory
  status          IdeaStatus   @default(DRAFT)
  stage           Stage        @default(DISCOVERY)
  isAnonymous     Boolean      @default(false)
  challengeId     Int?
  challenge       Challenge?   @relation(fields: [challengeId], references: [id])

  submittedBy Int
  submitter   User         @relation(fields: [submittedBy], references: [id])
  submittedAt DateTime     @default(now())

  reviewedBy  Int?
  reviewedAt  DateTime?
  reviewNotes String?      @db.Text

  promotedAt  DateTime?
  projectCode String?      @unique

  voteCount     Int      @default(0)
  upvoteCount   Int      @default(0)
  downvoteCount Int      @default(0)
  viewCount     Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes        Vote[]
  comments     IdeaComment[]
  attachments  IdeaAttachment[]
  tags         IdeaTag[]
  stageHistory IdeaStageHistory[]
  auditLogs    AuditLog[]

  @@index([status])
  @@index([category])
  @@index([submittedBy])
  @@index([createdAt])
  @@index([voteCount])
  @@index([status, createdAt])
  @@index([promotedAt])
}

model Vote {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voteType  VoteType @default(UPVOTE)
  createdAt DateTime @default(now())

  @@unique([ideaId, userId])
  @@index([ideaId])
  @@index([userId])
}

model IdeaComment {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String   @db.Text
  parentId  Int?
  parent    IdeaComment? @relation("IdeaCommentParent", fields: [parentId], references: [id])
  replies   IdeaComment[] @relation("IdeaCommentParent")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ideaId])
  @@index([userId])
  @@index([parentId])
}

model IdeaAttachment {
  id         Int                  @id @default(autoincrement())
  ideaId     Int
  idea       Idea                 @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String?
  safeStatus AttachmentSafeStatus @default(PENDING)
  uploadedAt DateTime             @default(now())

  @@index([ideaId])
}

model Tag {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  createdAt DateTime  @default(now())
  ideas     IdeaTag[]
}

model IdeaTag {
  ideaId Int
  tagId  Int
  idea   Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([ideaId, tagId])
  @@index([tagId])
}

model IdeaCount {
  id        Int        @id @default(autoincrement())
  status    IdeaStatus @unique
  count     Int        @default(0)
  updatedAt DateTime   @default(now()) @updatedAt
}

model Challenge {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  startAt     DateTime?
  endAt       DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  ideas       Idea[]
}

model IdeaStageHistory {
  id        Int      @id @default(autoincrement())
  ideaId    Int
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  fromStage Stage?
  toStage   Stage
  note      String?
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@index([ideaId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  ideaId    Int?
  idea      Idea?       @relation(fields: [ideaId], references: [id], onDelete: SetNull)
  userId    Int?
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    AuditAction
  message   String
  metadata  Json?
  createdAt DateTime     @default(now())

  @@index([ideaId])
  @@index([userId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  message   String
  data      Json?
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([createdAt])
}
