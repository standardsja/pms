// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// Also generate default client into node_modules for runtime dependencies
// Note: Single client output to src/generated/prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Request lifecycle statuses
enum RequestStatus {
  PENDING_FINANCE
  FINANCE_VERIFIED
  PENDING_PROCUREMENT
  APPROVED
  RETURNED_BY_FINANCE
  REJECTED
  FULFILLED
}

// Procurement domain enums
enum SupplierStatus {
  ACTIVE
  INACTIVE
}

enum RfqStatus {
  DRAFT
  SENT
  RECEIVED
  CLOSED
  CANCELLED
}

enum QuoteStatus {
  SUBMITTED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum POStatus {
  DRAFT
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  FULFILLED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  PAID
  FAILED
}

enum ApprovalEntity {
  REQUEST
  RFQ
  QUOTE
  PURCHASE_ORDER
  PAYMENT
}

enum ApprovalRole {
  DEPARTMENT_HEAD
  FINANCE
  EXECUTIVE_DIRECTOR
  PROCUREMENT_MANAGER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EvaluationStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

// Users & Auth
enum Role {
  USER
  MANAGER
  ADMIN
  INNOVATION_COMMITTEE
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         Role     @default(USER)
  mfaEnabled   Boolean  @default(false)
  mfaSecret    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Innovative Hub relations
  ideas        Idea[]
  votes        Vote[]
  ideaComments IdeaComment[]

  @@index([role])
  @@index([createdAt])
}

// ============================================
// INNOVATIVE HUB DOMAIN
// ============================================

enum IdeaStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PROMOTED_TO_PROJECT
}

enum IdeaCategory {
  PROCESS_IMPROVEMENT
  TECHNOLOGY
  CUSTOMER_SERVICE
  SUSTAINABILITY
  COST_REDUCTION
  PRODUCT_INNOVATION
  OTHER
}

model Idea {
  id             String       @id @default(cuid())
  title          String
  description    String       @db.Text
  category       IdeaCategory
  status         IdeaStatus   @default(DRAFT)
  
  // Submission
  submittedBy    String
  submitter      User         @relation(fields: [submittedBy], references: [id])
  submittedAt    DateTime     @default(now())
  
  // Review
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?      @db.Text
  
  // Promotion
  promotedAt     DateTime?
  projectCode    String?      @unique
  
  // Metadata
  voteCount      Int          @default(0)
  viewCount      Int          @default(0)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  votes          Vote[]
  comments       IdeaComment[]
  attachments    IdeaAttachment[]

  @@index([status])
  @@index([category])
  @@index([submittedBy])
  @@index([createdAt])
  @@index([voteCount])
}

model Vote {
  id        Int      @id @default(autoincrement())
  ideaId    String
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([ideaId, userId])
  @@index([ideaId])
  @@index([userId])
}

model IdeaComment {
  id        Int      @id @default(autoincrement())
  ideaId    String
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  text      String   @db.Text
  createdAt DateTime @default(now())

  @@index([ideaId])
  @@index([userId])
}

model IdeaAttachment {
  id        Int      @id @default(autoincrement())
  ideaId    String
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String?
  uploadedAt DateTime @default(now())

  @@index([ideaId])
}

model Request {
  // String id to align with frontend expectations; generated via cuid()
  id              String          @id @default(cuid())
  // Optional human-readable code (e.g., REQ-0001)
  code            String?         @unique

  title           String
  requester       String
  department      String
  status          RequestStatus   @default(PENDING_FINANCE)

  justification   String          @db.Text
  fundingSource   String?
  budgetCode      String?
  totalEstimated  Decimal         @db.Decimal(12, 2)

  // Track original procurement officer for returning after finance approval
  procurementOfficerId String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  items           RequestItem[]
  comments        Comment[]
  statusHistory   StatusHistory[]

  // Back-relations
  purchaseOrders  PurchaseOrder[]
  evaluations     Evaluation[]

  @@index([requester])
  @@index([department])
  @@index([status])
  @@index([createdAt])
}

model RequestItem {
  id         Int      @id @default(autoincrement())

  requestId  String
  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  description String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(12, 2)
}

model Comment {
  id         Int       @id @default(autoincrement())

  requestId  String
  request    Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)

  actor      String
  date       DateTime  @default(now())
  text       String    @db.Text
}

model StatusHistory {
  id         Int            @id @default(autoincrement())

  requestId  String
  request    Request        @relation(fields: [requestId], references: [id], onDelete: Cascade)

  status     RequestStatus
  date       DateTime       @default(now())
  actor      String
  note       String?        @db.Text
}

// Reference tables
model Department {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
}

// Suppliers
model Supplier {
  id        String         @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  taxId     String?
  status    SupplierStatus @default(ACTIVE)
  createdAt DateTime       @default(now())

  catalogItems CatalogItem[]
  quotes       Quote[]
  rfqInvites   RfqInvitation[]
  purchaseOrders PurchaseOrder[]
  evaluations    Evaluation[]

  @@index([name])
  @@index([status])
}

// Catalog
model CatalogItem {
  id          Int       @id @default(autoincrement())
  sku         String?   @unique
  name        String
  description String?
  unitPrice   Decimal   @db.Decimal(12, 2)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  // Back-relations
  rfqItems    RFQItem[]

  @@index([name])
  @@index([supplierId])
}

// RFQ
model RFQ {
  id          String      @id @default(cuid())
  code        String?     @unique
  title       String
  requester   String
  department  String
  status      RfqStatus   @default(DRAFT)
  dueDate     DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items       RFQItem[]
  invitations RfqInvitation[]
  quotes      Quote[]
  purchaseOrders PurchaseOrder[]

  @@index([requester])
  @@index([department])
  @@index([status])
  @@index([createdAt])
}

model RFQItem {
  id          Int      @id @default(autoincrement())
  rfqId       String
  rfq         RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  catalogItemId Int?
  catalogItem   CatalogItem? @relation(fields: [catalogItemId], references: [id])

  description String
  quantity    Int
  unit        String?
  notes       String?  @db.Text

  @@index([rfqId])
  @@index([catalogItemId])
}

model RfqInvitation {
  id         Int      @id @default(autoincrement())
  rfqId      String
  rfq        RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  sentAt     DateTime @default(now())
  respondedAt DateTime?

  @@unique([rfqId, supplierId])
  @@index([supplierId])
}

// Quotes
model Quote {
  id          String      @id @default(cuid())
  rfqId       String
  rfq         RFQ         @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierId  String
  supplier    Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  status      QuoteStatus @default(SUBMITTED)
  total       Decimal     @db.Decimal(12, 2)
  submittedAt DateTime    @default(now())

  items       QuoteItem[]

  @@index([rfqId])
  @@index([supplierId])
  @@index([status])
}

model QuoteItem {
  id        Int      @id @default(autoincrement())
  quoteId   String
  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)

  @@index([quoteId])
}

// Purchase Orders
model PurchaseOrder {
  id           String   @id @default(cuid())
  code         String?  @unique
  rfqId        String?
  rfq          RFQ?     @relation(fields: [rfqId], references: [id])
  requestId    String?
  request      Request? @relation(fields: [requestId], references: [id])
  supplierId   String
  supplier     Supplier @relation(fields: [supplierId], references: [id])
  status       POStatus @default(DRAFT)
  total        Decimal  @db.Decimal(12, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  expectedDate DateTime?

  items        PurchaseOrderItem[]
  payments     Payment[]

  @@index([rfqId])
  @@index([requestId])
  @@index([supplierId])
  @@index([status])
}

model PurchaseOrderItem {
  id             Int           @id @default(autoincrement())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  description     String
  quantity        Int
  unitPrice       Decimal @db.Decimal(12, 2)

  @@index([purchaseOrderId])
}

// Payments
model Payment {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  amount          Decimal       @db.Decimal(12, 2)
  status          PaymentStatus @default(PENDING)
  method          String?
  referenceNo     String?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())

  @@index([purchaseOrderId])
  @@index([status])
}

// Approvals (generic across entities)
model Approval {
  id         Int            @id @default(autoincrement())
  entityType ApprovalEntity
  entityId   String
  role       ApprovalRole
  status     ApprovalStatus @default(PENDING)
  actedBy    String?
  actedAt    DateTime?
  note       String?        @db.Text

  @@index([entityType, entityId])
  @@index([role])
  @@index([status])
}

// Evaluations (simplified)
model Evaluation {
  id          String           @id @default(cuid())
  requestId   String?
  request     Request?         @relation(fields: [requestId], references: [id])
  supplierId  String?
  supplier    Supplier?        @relation(fields: [supplierId], references: [id])
  createdBy   String
  status      EvaluationStatus @default(DRAFT)
  score       Int?
  notes       String?          @db.Text
  createdAt   DateTime         @default(now())

  @@index([requestId])
  @@index([supplierId])
  @@index([status])
}
